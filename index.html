<!DOCTYPE html>
<html>

<head>
  <title>Stream audio from Worker to AudioWorklet</title>
</head>

<body>
  <audio autoplay controls></audio>
  <script>
    // AudioWorkletStream 
    // Stream audio from Worker to AudioWorklet (POC)
    // guest271314 2-24-2020
    "use strict";
    if (gc) gc();
    const handleEvents = e => globalThis.console.log(e.type === "statechange" ? e.target.state : e.type);
    // TODO "seamless" playback; media fragment concatenation, processing; seekable streams
    const audio = document.querySelector("audio");
    // audio.ontimeupdate = e => console.log(audio.currentTime, ac.currentTime);
    const events = ["durationchange", "ended", "loadedmetadata", "pause"
    , "play", "playing", "suspend", "waiting"];
    for (let event of events) audio.addEventListener(event, handleEvents);

    class AudioWorkletStream {
      constructor({
        codecs = ["audio/wav"]
        , urls = [""]
        , sampleRate = 44100
        , numberOfChannels = 2
        , latencyHint = "playback"
        , workletOptions = {}
      } = {}) {
        this.mediaStreamTrack = new Promise(async resolve => {
          gc();
          const ac = new AudioContext({
            sampleRate,
            numberOfChannels,
            latencyHint
          });
          await ac.suspend();
          ac.onstatechange = handleEvents;
          await ac.audioWorklet.addModule("audioWorklet.js");
          const aw = new AudioWorkletNode(ac, "audio-data-worklet-stream", workletOptions);
          const msd = new MediaStreamAudioDestinationNode(ac);
          const {
            stream
          } = msd;
          // MediaStreamTrack, kind "audio"
          const [track] = stream.getAudioTracks();
          // fulfill Promise with MediaStreamTrack
          resolve(track);
          // set enabled to false
          track.enabled = false;
          aw.connect(msd);
          // inactive event at Chromium 81
          // not longer defined in Media Capture and Streams specification
          // Firefox does not yet fully support AudioWorklet
          stream.oninactive = stream.onactive = handleEvents;
          // not dispatched at Chromium 81
          track.onmute = track.onunmute = track.onended = handleEvents;
          // transfer sources, here, e.g., file handle
          // ReadableStream, WritableStream (https://github.com/whatwg/streams/blob/master/transferable-streams-explainer.md)
          // etc.
          const worker = new Worker("worker.js", {
            type: "module"
          });
          worker.postMessage({
            port: aw.port,
            codecs,
            urls
          }, [aw.port]);
          worker.onmessage = async e => {
            // use suspend(), resume() to synchronize to degree possible
            // with currentTime of <audio> with MediaStream set as srcObject
            if (e.data.start) {
              track.enabled = true;
              await ac.resume();
            }
            if (e.data.ended) {
              track.stop();
              track.enabled = false;
              await ac.suspend();
              msd.disconnect();
              aw.disconnect();
              aw.port.close();
              worker.terminate();
              await ac.close();
              // audio.srcObject.removeTrack(audio.srcObject.getAudioTracks()[0]);
              // audio.load();
              for (let event of events) audio.removeEventListener(event, handleEvents);
              if (gc) gc();
              // currentTime(s)    
              console.log({
                audio: audio.currentTime,
                currentTime: e.data.currentTime,
                currentFrame: e.data.currentFrame,
                minutes: Math.floor(e.data.currentTime / 60),
                seconds: ((e.data.currentTime / 60) - Math.floor(e.data.currentTime / 60)) * 60
              });
            };
          };
        });
      };
    };

    (async() => {
      // set parameters as arrays for potential "infinite" input, output stream
      let workletStream = new AudioWorkletStream({
        codecs: ["audio/wav"],
        // 277MB
        urls: ["https://ia800301.us.archive.org/10/items/DELTAnine2013-12-11.WAV/Deltanine121113Pt3Wav.wav"],
        sampleRate: 44100,
        numberOfChannels: 2,
        latencyHint: "playback",
        workletOptions: {
          numberOfInputs: 2,
          numberOfOutputs: 2,
          channelCount: 2,
          processorOptions: {
            buffers: {
              channel0: [],
              channel1: []
            },
            i: 0
          }
        }
      });
      let {
        mediaStreamTrack
      } = workletStream;
      let mediaStream = new MediaStream();
      // Chromium bug, https://bugs.chromium.org/p/chromium/issues/detail?id=1045832 
      // currentTime does not progress at HTMLMediaElement when addTrack() is called on a MediaStream 
      // set as srcObject on <audio>, <video> where no MediaStreamTrack (getAudioTracks() // []) is previously set
      mediaStream.addTrack(await mediaStreamTrack);
      audio.srcObject = mediaStream;
    })();
  </script>
</body>

</html>