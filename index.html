<!DOCTYPE html>
<!-- https://github.com/guest271314/AudioWorkletStream -->
<html>
  <head>
    <title>
      fetch() => ReadableStream => SharedArrayBuffer => AudioWorklet
    </title>
  </head>
  <body>
    <button>Resume</button><button>Suspend</button>
    <script type="worklet" id="smaws">
      class SharedMemoryAudioWorkletStream extends AudioWorkletProcessor {
        constructor(options) {
          super();
          Object.assign(this, options.processorOptions);
          this.port.onmessage = e => {
            this.uint8_sab = e.data;
            console.log(sampleRate, currentTime, currentFrame, this.offset, this.length);
          };
        }
        process(inputs, outputs) {
          const channels = outputs.flat();
          if (this.offset === this.length) {
            console.log(currentTime, currentFrame, this.offset, this.length);
            this.port.postMessage('audio worklet stream done');
            return false;
          }
          const uint8 = new Uint8Array(512);
          for (let i = 0; i < 512; i++, this.offset++) {
            if (this.offset === this.length) {
              break;
            }
            uint8[i] = this.uint8_sab[this.offset];
          }
          const uint16 = new Uint16Array(uint8.buffer);
          // https://stackoverflow.com/a/35248852
          for (let i = 0, j = 0, n = 1; i < uint16.length; i++) {
            const int = uint16[i];
            // If the high bit is on, then it is a negative number, and actually counts backwards.
            const float = int >= 0x8000 ? -(0x10000 - int) / 0x8000 : int / 0x7fff;
            // interleave
            channels[n = ++n % 2][!n ? j++ : j-1] = float;
          };
          return true;
        }
      };
      registerProcessor(
        'shared-memory-audio-worklet-stream',
        SharedMemoryAudioWorkletStream
      );
    </script>
    <script>
      (async _ => {
        try {
          if (globalThis.gc) {
            gc();
          };
          const [resume, suspend] = document.querySelectorAll('button');
          resume.onclick = async _ => await ac.resume();
          suspend.onclick = async _ => await ac.suspend();
          const url = 'https://ia800301.us.archive.org/10/items/DELTAnine2013-12-11.WAV/Deltanine121113Pt3Wav.wav';
          const worklet = URL.createObjectURL(
            new Blob([document.getElementById('smaws').textContent], {
              type: 'text/javascript',
            })
          );
          const { headers, body } = await fetch(url, { cache: 'no-store' });
          // Firefox does not expose Content-Length header
          // https://bugzilla.mozilla.org/show_bug.cgi?id=1654212
          const length = +headers.get('content-length') || 65536 * 4436;
          const ac = new AudioContext({
            latencyHint: 0,
            sampleRate: 44100,
            numberOfChannels: 2,
          });
          await ac.suspend();
          await ac.audioWorklet.addModule(worklet);
          const aw = new AudioWorkletNode(
            ac,
            'shared-memory-audio-worklet-stream',
            {
              numberOfInputs: 1,
              numberOfOutputs: 2,
              outputChannelCount:[2, 2],
              processorOptions: { length, offset: 0 },
            }
          );
          aw.onprocessorerror = e => {
            console.error(e);
            console.trace();
          };
          aw.port.onmessage = async e => {
            console.log(e.data);
            await ac.suspend();
          };
          aw.connect(ac.destination);
          const memory = new WebAssembly.Memory({
            initial: Math.floor(length / 65536) + 1,
            maximum: Math.floor(length / 65536) + 1,
            shared: true,
          });
          const uint8_sab = new Uint8Array(memory.buffer);
          aw.port.postMessage(uint8_sab);
          let offset = 0;
          const reader = body.getReader();
          const stream = await (async function process({ value, done }) {
            if (done) {
              await reader.closed;
              return 'read/write done';
            };
            for (let i = !offset ? 44 : 0; i < value.length; i++) {
              uint8_sab[offset++] = value[i];
            };
            return process(await reader.read());
          })(await reader.read());
          console.log(stream);
        } catch (e) {
          console.error(e);
          throw e;
        };
      })().catch(console.trace);
    </script>
  </body>
</html>
